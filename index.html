<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Celeste Ice Cream - Sistema POS</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <style>
    body { font-family: 'Roboto', sans-serif; margin: 0; padding: 0; background-color: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    header { background-color: #3f51b5; color: white; padding: 20px; text-align: center; border-radius: 5px; margin-bottom: 20px; position: relative; }
    .user-badge { position: absolute; right: 20px; top: 20px; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.9rem;}
    
    .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; overflow-x: auto; }
    .tab { padding: 10px 20px; cursor: pointer; background-color: #f1f1f1; border: 1px solid #ddd; border-bottom: none; margin-right: 5px; border-radius: 5px 5px 0 0; white-space: nowrap; }
    .tab.active { background-color: #3f51b5; color: white; }
    
    .tab-content { display: none; background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .tab-content.active { display: block; }
    
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: 500; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    
    button { background-color: #3f51b5; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 500; transition: 0.3s; }
    button:hover { background-color: #303f9f; }
    .btn-danger { background-color: #f44336; }
    .btn-success { background-color: #4caf50; }
    
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .dashboard-card { background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
    .dashboard-card h3 { margin-top: 0; color: #3f51b5; }
    .dashboard-card p { font-size: 24px; margin: 10px 0; font-weight: bold; color: #333; }
    .low-stock-list { margin-top: 10px; text-align: left; font-size: 14px; max-height: 100px; overflow-y: auto; }
    .low-stock-item { padding: 5px; border-bottom: 1px solid #eee; color: #d32f2f; }
    
    .chart-container { position: relative; height: 300px; width: 100%; margin: 0 auto; }

    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    
    #login-modal .modal-content { text-align: center; }
    .user-btn { display: block; width: 100%; padding: 15px; margin: 10px 0; background: white; border: 2px solid #3f51b5; color: #3f51b5; border-radius: 8px; font-size: 1.1em; cursor: pointer; }
    .user-btn:hover { background: #3f51b5; color: white; }

    .select2-container .select2-selection--single { height: 42px !important; padding: 6px; border: 1px solid #ddd; }
    .select2-container--default .select2-selection--single .select2-selection__arrow { top: 8px !important; }

    .notification { position: fixed; top: 20px; right: 20px; padding: 15px; background-color: #4caf50; color: white; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 2000; display: none; }
    .notification.error { background-color: #f44336; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3f51b5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; display: none; margin-left: 10px;}
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .report-total-card {
      background: #e8f5e9; border: 1px solid #a5d6a7; color: #2e7d32;
      padding: 15px; margin-top: 15px; border-radius: 8px;
      font-size: 1.4em; text-align: right; font-weight: bold;
    }
    .search-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #3f51b5; border-radius: 5px; font-size: 1em; }
    .toggle-container { display: flex; align-items: center; margin-bottom: 15px; background: #e3f2fd; padding: 10px; border-radius: 5px; }
    .toggle-container input { width: auto; margin-right: 10px; transform: scale(1.5); }
    
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #f1f1f1; }
  </style>
</head>
<body>

  <div id="login-modal" class="modal" style="display:flex; align-items:center; justify-content:center;">
    <div class="modal-content">
      <h2 style="color: #3f51b5;">üç¶ Inicio de Turno</h2>
      <p>Selecciona tu perfil:</p>
      <button class="user-btn" onclick="selectUser('ADMINISTRADOR')">ADMINISTRADOR</button>
      <button class="user-btn" onclick="selectUser('CAJERO 1')">CAJERO 1</button>
      <button class="user-btn" onclick="selectUser('CAJERO 2')">CAJERO 2</button>
    </div>
  </div>

  <div class="container">
    <header>
      <h1>Celeste Ice Cream POS</h1>
      <div class="user-badge" onclick="showLogin()">
        <i class="material-icons">account_circle</i>
        <span id="user-name">Seleccionar Usuario</span>
      </div>
    </header>
    
    <div class="tabs">
      <div class="tab active" data-tab="dashboard">Dashboard</div>
      <div class="tab" data-tab="pos">Punto de Venta</div>
      <div class="tab" data-tab="inventory">Inventario</div>
      <div class="tab" data-tab="expenses">Gastos</div>
      <div class="tab" data-tab="reports">Reportes</div>
      <div class="tab" data-tab="assets">Activos Fijos</div>
    </div>
    
    <div id="dashboard-content" class="tab-content active">
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h3>Resumen de Inventario</h3>
          <p id="inventory-count">0</p>
          <div class="low-stock-list" id="low-stock-products"></div>
        </div>
        <div class="dashboard-card">
          <h3>Ventas Recientes</h3>
          <p>Ventas hoy: <span id="today-sales-count">0</span></p>
          <p>Ingresos hoy: <span id="today-revenue" style="color:#4caf50">$0</span></p>
          <p>Ventas este mes: <span id="month-sales-count">0</span></p>
          <p>Ingresos este mes: <span id="month-revenue">0</span></p>
        </div>
        <div class="dashboard-card">
          <h3>Gastos Recientes</h3>
          <p>Gastos este mes: <span id="month-expenses">0</span></p>
        </div>
      </div>
      
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h3>Ventas por Tipo (Hoy)</h3>
          <div class="chart-container"><canvas id="sale-type-chart"></canvas></div>
        </div>
        <div class="dashboard-card">
          <h3>M√©todos de Pago (Hoy)</h3>
          <div class="chart-container"><canvas id="payment-method-chart"></canvas></div>
        </div>
      </div>
    </div>
    
    <div id="pos-content" class="tab-content">
      <div class="dashboard-grid">
        <div> 
          <h2>Nueva Venta</h2>
          <div class="form-group">
            <label>Tipo de Venta</label>
            <select id="sale-type" onchange="updateCartPrices()">
              <option value="MESA">Mesa</option>
              <option value="LLEVAR">Para Llevar</option>
            </select>
          </div>
          <div class="form-group">
            <label>Producto</label>
            <select id="product-select" style="width:100%"><option></option></select>
          </div>
          <div class="form-group">
             <label>Cantidad</label>
             <input type="number" id="qty" value="1" min="1">
          </div>
          <div id="flavor-section" style="display:none; border:1px solid #eee; padding:10px; border-radius:5px; margin-bottom:15px;">
            <label style="color:#3f51b5">Seleccionar Sabores:</label>
            <div id="flavor-inputs"></div>
          </div>
          <button onclick="addToCart()" style="width:100%">AGREGAR AL CARRITO</button>
        </div>
        
        <div style="background:#fff; padding:15px; border-radius:5px; border:1px solid #ddd;"> 
          <h3>Carrito</h3>
          <div id="cart-list" style="min-height:200px; max-height:400px; overflow-y:auto; border-bottom:1px solid #eee; margin-bottom:10px;">
            <p style="text-align:center; padding:20px; color:#999">Carrito Vac√≠o</p>
          </div>
          <div style="font-size:1.5em; text-align:right; font-weight:bold; color:#3f51b5; margin-bottom:10px;">
            Total: $<span id="cart-total">0</span>
          </div>
          <div class="form-group">
            <label>M√©todo de Pago</label>
            <select id="payment-method">
              <option value="EFECTIVO">Efectivo</option>
              <option value="NEQUI">Nequi</option>
              <option value="BANCOLOMBIA">Bancolombia</option>
              <option value="TARJETA">Tarjeta</option>
            </select>
          </div>
          <button class="btn-success" onclick="processSale()" style="width:100%; font-size:1.2em">REGISTRAR VENTA</button>
        </div>
      </div>
    </div>
    
    <div id="inventory-content" class="tab-content">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Inventario</h2>
        <button onclick="openModal('inventory-modal')">Agregar Producto</button>
      </div>
      <input type="text" id="inv-search" class="search-input" placeholder="üîç Buscar insumo por nombre...">
      <table id="inv-table"><thead><tr><th>Nombre</th><th>Stock</th><th>Unidad</th><th>M√≠nimo</th><th>Acciones</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="expenses-content" class="tab-content">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Gastos</h2>
        <button onclick="openModal('expense-modal')">Agregar Gasto</button>
      </div>
      <table id="exp-table"><thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Monto</th><th>Categor√≠a</th><th>Pago</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="reports-content" class="tab-content">
      <h2>Reportes</h2>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin-bottom:20px; background:#e0e0e0; padding:15px; border-radius:5px;">
        <div class="form-group" style="margin:0">
          <label>Reporte</label>
          <select id="rep-type"><option value="ventas">Ventas</option><option value="gastos">Gastos</option></select>
        </div>
        <div class="form-group" style="margin:0">
          <label>Desde</label>
          <input type="date" id="rep-start">
        </div>
        <div class="form-group" style="margin:0">
          <label>Hasta</label>
          <input type="date" id="rep-end">
        </div>
        <button onclick="runReport()">Generar Reporte <div class="loader" id="rep-loader"></div></button>
      </div>
      <div id="rep-result"></div>
      <br>
      <h3>Historial Reciente</h3>
      <div style="overflow-x:auto;">
        <table id="history-table"><thead><tr><th>ID</th><th>Fecha</th><th>Producto</th><th>Total</th><th>Pago</th><th>Usuario</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
    
    <div id="assets-content" class="tab-content">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Activos Fijos</h2>
        <button onclick="openModal('asset-modal')">Agregar Activo</button>
      </div>
      <table id="asset-table"><thead><tr><th>Nombre</th><th>Descripci√≥n</th><th>Valor</th><th>Ubicaci√≥n</th><th>Estado</th><th>Acciones</th></tr></thead><tbody></tbody></table>
    </div>

  </div>

  <div id="inventory-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('inventory-modal')">&times;</span>
      <h2>Insumo / Producto</h2>
      <form id="form-inv">
        <input type="hidden" id="inv-id">
        <div class="form-group"><label>Nombre</label><input type="text" id="inv-name" required></div>
        <div class="form-group"><label>Stock Inicial</label><input type="number" id="inv-stock" required></div>
        <div class="form-group"><label>Unidad (gr, unidad)</label><input type="text" id="inv-unit"></div>
        <div class="form-group"><label>Stock M√≠nimo (Alerta)</label><input type="number" id="inv-min"></div>
        <div class="toggle-container">
          <input type="checkbox" id="inv-is-product" onchange="toggleProductFields()">
          <label for="inv-is-product" style="cursor:pointer; margin-bottom:0; font-weight:bold;">¬øVender al p√∫blico?</label>
        </div>
        <div id="product-extra-fields" style="display:none; border:1px dashed #3f51b5; padding:10px; margin-bottom:10px; border-radius:5px;">
          <div class="form-group"><label>Precio Mesa</label><input type="number" id="inv-price-mesa"></div>
          <div class="form-group"><label>Precio Llevar</label><input type="number" id="inv-price-llevar"></div>
        </div>
        <button type="submit">Guardar</button>
      </form>
    </div>
  </div>

  <div id="expense-modal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('expense-modal')">&times;</span><h2>Gasto</h2><form id="form-exp"><input type="text" id="exp-desc" placeholder="Descripci√≥n" required><br><br><input type="number" id="exp-amount" placeholder="Monto" required><br><br><select id="exp-cat"><option>Compras</option><option>Sueldos</option><option>Servicios</option><option>Otros</option></select><br><br><select id="exp-pay"><option>EFECTIVO</option><option>NEQUI</option><option>BANCOLOMBIA</option></select><br><br><button type="submit">Guardar</button></form></div></div>
  <div id="asset-modal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('asset-modal')">&times;</span><h2>Activo Fijo</h2><form id="form-asset"><input type="hidden" id="asset-id"><input type="text" id="asset-name" placeholder="Nombre" required><br><br><textarea id="asset-desc" placeholder="Descripci√≥n"></textarea><br><br><input type="number" id="asset-val" placeholder="Valor"><br><br><input type="text" id="asset-loc" placeholder="Ubicaci√≥n"><br><br><select id="asset-state"><option>Bueno</option><option>Regular</option><option>Malo</option></select><br><br><button type="submit">Guardar</button></form></div></div>
  <div id="notification" class="notification"></div>

  <script>
    let ACTIVE_USER = "Desconocido";
    let products = [], flavors = [], cart = [];
    let chart1 = null, chart2 = null;

    $(document).ready(function() {
      let storedUser = localStorage.getItem('celeste_pos_user');
      if(storedUser) {
        ACTIVE_USER = storedUser;
        $('#user-name').text(ACTIVE_USER);
        $('#login-modal').hide();
      } else {
        $('#login-modal').show();
      }
      
      $('#product-select').select2({ placeholder: "Buscar producto...", width: '100%' });
      $('.tab').click(function(){ switchTab($(this).data('tab')); });
      $('#product-select').on('select2:select', onProductSelect);
      $('#form-inv').submit(saveInventory);
      $('#form-exp').submit(saveExpense);
      $('#form-asset').submit(saveAsset);
      
      $('#inv-search').on('keyup', function() {
        var value = $(this).val().toLowerCase();
        $("#inv-table tbody tr").filter(function() {
          $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
      });
      loadDashboard();
    });

    function toggleProductFields() {
      if($('#inv-is-product').is(':checked')) {
        $('#product-extra-fields').slideDown();
        $('#inv-price-mesa').prop('required', true);
        $('#inv-price-llevar').prop('required', true);
      } else {
        $('#product-extra-fields').slideUp();
        $('#inv-price-mesa').prop('required', false);
        $('#inv-price-llevar').prop('required', false);
      }
    }

    function selectUser(name) {
      ACTIVE_USER = name;
      localStorage.setItem('celeste_pos_user', name);
      $('#user-name').text(name);
      $('#login-modal').fadeOut();
      showNotif("Bienvenido " + name);
    }
    function showLogin() { $('#login-modal').css('display','flex'); }

    function switchTab(tab) {
      $('.tab').removeClass('active');
      $(`.tab[data-tab="${tab}"]`).addClass('active');
      $('.tab-content').hide();
      $(`#${tab}-content`).fadeIn();
      if(tab === 'pos') { loadProducts(); loadFlavors(); }
      if(tab === 'inventory') loadInventory();
      if(tab === 'expenses') loadExpenses();
      if(tab === 'assets') loadAssets();
      if(tab === 'reports') loadHistory();
      if(tab === 'dashboard') loadDashboard();
    }

    function loadDashboard() { google.script.run.withSuccessHandler(drawDashboard).getDashboardData(); }
    function drawDashboard(data) {
      $('#inventory-count').text(data.inventoryCount);
      let lowStockHtml = data.lowStockProducts.map(p => `<div class="low-stock-item">${p.name}: ${p.stockActual}/${p.stockMinimo}</div>`).join('') || '<div style="color:green">Todo OK</div>';
      $('#low-stock-products').html(lowStockHtml);
      $('#today-sales-count').text(data.todaySalesCount);
      $('#today-revenue').text(data.todayRevenue);
      $('#month-sales-count').text(data.monthSalesCount);
      $('#month-revenue').text(data.monthRevenue);
      $('#month-expenses').text(data.monthExpenses);
      
      if(chart1) chart1.destroy();
      chart1 = new Chart(document.getElementById('sale-type-chart'), { type: 'pie', data: { labels: ['Mesa', 'Llevar'], datasets: [{ data: [data.todayMesaCount, data.todayLlevarCount], backgroundColor: ['#3f51b5', '#f44336'] }] }, options: { responsive: true, maintainAspectRatio: false } });
      if(chart2) chart2.destroy();
      const pData = [parseInt(data.paymentMethodsToday.EFECTIVO.replace(/\D/g,''))||0, parseInt(data.paymentMethodsToday.NEQUI.replace(/\D/g,''))||0, parseInt(data.paymentMethodsToday.BANCOLOMBIA.replace(/\D/g,''))||0, parseInt(data.paymentMethodsToday.TARJETA.replace(/\D/g,''))||0];
      chart2 = new Chart(document.getElementById('payment-method-chart'), { type: 'pie', data: { labels: ['Efectivo', 'Nequi', 'Bancolombia', 'Tarjeta'], datasets: [{ data: pData, backgroundColor: ['#4caf50', '#2196f3', '#ffeb3b', '#ff9800'] }] }, options: { responsive: true, maintainAspectRatio: false } });
    }

    function loadProducts() {
      google.script.run.withSuccessHandler(res => {
        products = res;
        let html = '<option></option>';
        res.forEach(p => html += `<option value="${p.id}">${p.name} - $${formatMoney(p.PRECIO_MESA)}</option>`);
        $('#product-select').html(html).trigger('change');
      }).getProducts();
    }
    function loadFlavors() { google.script.run.withSuccessHandler(res => flavors = res).getFlavors(); }
    function onProductSelect() {
      const id = $('#product-select').val();
      const p = products.find(x => x.id === id);
      const $div = $('#flavor-inputs');
      $div.empty();
      if(p && p.CANTIDAD_BOLAS > 0) {
        $('#flavor-section').show();
        for(let i=1; i<=p.CANTIDAD_BOLAS; i++) {
          let sel = `<select class="flav-sel" style="width:100%; margin-bottom:5px;"><option value="">Sabor ${i}...</option>`;
          flavors.forEach(f => sel += `<option value="${f.name}">${f.name}</option>`);
          sel += `</select>`;
          $div.append(sel);
        }
      } else { $('#flavor-section').hide(); }
    }
    function addToCart() {
      const id = $('#product-select').val();
      if(!id) return showNotif("Selecciona producto", true);
      const p = products.find(x => x.id === id);
      const qty = parseInt($('#qty').val()) || 1;
      const type = $('#sale-type').val();
      const price = type === 'MESA' ? p.PRECIO_MESA : p.PRECIO_LLEVAR;
      let flavs = [];
      if(p.CANTIDAD_BOLAS > 0) {
        $('.flav-sel').each((i, el) => { if($(el).val()) flavs.push($(el).val()); });
        if(flavs.length < p.CANTIDAD_BOLAS) return showNotif("Faltan sabores", true);
      }
      cart.push({ product: p, name: p.name, qty: qty, price: price, total: price*qty, flavors: flavs });
      renderCart();
      $('#product-select').val(null).trigger('change'); $('#qty').val(1); $('#flavor-section').hide();
    }
    function renderCart() {
      const $list = $('#cart-list'); $list.empty(); let total = 0;
      cart.forEach((item, idx) => {
        total += item.total;
        $list.append(`<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><div><b>${item.name}</b> x${item.qty}<br><small>${item.flavors.join(', ')}</small></div><div style="text-align:right">$${formatMoney(item.total)}<br><i class="material-icons" style="color:red; cursor:pointer;" onclick="remItem(${idx})">delete</i></div></div>`);
      });
      $('#cart-total').text(formatMoney(total));
    }
    function remItem(i) { cart.splice(i,1); renderCart(); }
    function updateCartPrices() {
       const type = $('#sale-type').val();
       cart.forEach(item => { item.price = type === 'MESA' ? item.product.PRECIO_MESA : item.product.PRECIO_LLEVAR; item.total = item.price * item.qty; });
       renderCart();
    }
    function processSale() {
      if(cart.length === 0) return showNotif("Carrito vac√≠o", true);
      const sale = { items: cart, type: $('#sale-type').val(), payMethod: $('#payment-method').val(), user: ACTIVE_USER };
      google.script.run.withSuccessHandler(() => { cart = []; renderCart(); showNotif("Venta registrada!"); }).withFailureHandler(e => showNotif(e.message, true)).registerSale(sale);
    }

    function runReport() {
      const type = $('#rep-type').val();
      const s = $('#rep-start').val();
      const e = $('#rep-end').val();
      if(!s || !e) return showNotif("Faltan fechas", true);
      $('#rep-loader').show();
      const func = type === 'ventas' ? 'getSalesReport' : 'getExpenseReport';
      google.script.run.withSuccessHandler(data => {
        $('#rep-loader').hide();
        drawReportTable(data);
      }).withFailureHandler(err => { $('#rep-loader').hide(); showNotif(err.message, true); })[func](s, e);
    }
    function drawReportTable(data) {
      if(!data || data.length === 0) { $('#rep-result').html('<p style="text-align:center; padding:20px;">Sin datos</p>'); return; }
      let totalSum = 0;
      data.forEach(row => { let val = row['TOTAL'] || row['MONTO'] || 0; totalSum += parseFloat(val) || 0; });
      let html = `<div class="report-total-card">TOTAL PERIODO: $${formatMoney(totalSum)}</div><div style="overflow-x:auto;"><table class="report-table"><thead><tr>`;
      Object.keys(data[0]).forEach(k => html += `<th>${k}</th>`);
      html += '</tr></thead><tbody>';
      data.forEach(r => {
        html += '<tr>';
        Object.keys(r).forEach(k => {
           let val = r[k];
           if((k === 'TOTAL' || k === 'MONTO' || k === 'VALOR') && typeof val === 'number') val = '$'+formatMoney(val);
           html += `<td>${val}</td>`;
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';
      $('#rep-result').html(html);
    }

    function loadInventory() { google.script.run.withSuccessHandler(d => { $('#inv-table tbody').html(d.map(i => `<tr><td>${i.name}</td><td>${i.stock}</td><td>${i.unit}</td><td>${i.min}</td><td><button class="btn-danger" onclick="delInv('${i.id}')">X</button> <button onclick="editInv('${i.id}')">Edit</button></td></tr>`).join('')); }).getInventoryData(); }
    function saveInventory(e) { 
      e.preventDefault(); 
      const isProd = $('#inv-is-product').is(':checked');
      const obj = { 
        id: $('#inv-id').val(), 
        name: $('#inv-name').val(), 
        stock: $('#inv-stock').val(), 
        unit: $('#inv-unit').val(), 
        min: $('#inv-min').val(), 
        user: ACTIVE_USER,
        addToProducts: isProd,
        priceMesa: isProd ? $('#inv-price-mesa').val() : 0,
        priceLlevar: isProd ? $('#inv-price-llevar').val() : 0
      }; 
      const func = obj.id ? 'updateInventory' : 'addInventory'; 
      google.script.run
        .withSuccessHandler(()=>{ closeModal('inventory-modal'); loadInventory(); showNotif("Guardado OK"); })
        .withFailureHandler(e => showNotif(e.message, true)) 
        [func](obj); 
    }
    
    function openModal(id) { 
        $(`#${id} form`)[0].reset(); 
        $(`#${id} input[type=hidden]`).val(''); 
        if(id === 'inventory-modal') {
            $('#product-extra-fields').hide();
            $('#inv-price-mesa').prop('required', false);
            $('#inv-price-llevar').prop('required', false);
        }
        $(`#${id}`).show(); 
    }

    function delInv(id) { if(confirm("¬øEliminar?")) google.script.run.withSuccessHandler(loadInventory).deleteInventory(id, ACTIVE_USER); }
    function editInv(id) { 
        google.script.run.withSuccessHandler(i => { 
            $('#inv-id').val(i.id); 
            $('#inv-name').val(i.name); 
            $('#inv-stock').val(i.stock); 
            // Reset fields
            $('#inv-unit').val(i.unit);
            $('#inv-min').val(i.min);
            $('#inventory-modal').show(); 
        }).getInventoryItem(id); 
    }

    function loadExpenses() { google.script.run.withSuccessHandler(d => { $('#exp-table tbody').html(d.map(x => `<tr><td>${x.date}</td><td>${x.desc}</td><td>$${formatMoney(x.amount)}</td><td>${x.cat}</td><td>${x.pay}</td></tr>`).join('')); }).getExpensesHistory(); }
    function saveExpense(e) { e.preventDefault(); const obj = { desc: $('#exp-desc').val(), amount: $('#exp-amount').val(), cat: $('#exp-cat').val(), pay: $('#exp-pay').val(), user: ACTIVE_USER }; google.script.run.withSuccessHandler(()=>{ closeModal('expense-modal'); loadExpenses(); }).addExpense(obj); }

    function loadAssets() { google.script.run.withSuccessHandler(d => { $('#asset-table tbody').html(d.map(a => `<tr><td>${a.name}</td><td>${a.desc}</td><td>$${formatMoney(a.val)}</td><td>${a.loc}</td><td>${a.state}</td><td><button class="btn-danger" onclick="delAsset('${a.id}')">X</button></td></tr>`).join('')); }).getAssetsData(); }
    function saveAsset(e) { e.preventDefault(); const obj = { name: $('#asset-name').val(), desc: $('#asset-desc').val(), val: $('#asset-val').val(), loc: $('#asset-loc').val(), state: $('#asset-state').val(), user: ACTIVE_USER }; google.script.run.withSuccessHandler(()=>{ closeModal('asset-modal'); loadAssets(); }).addAsset(obj); }
    function delAsset(id) { if(confirm("¬øEliminar?")) google.script.run.withSuccessHandler(loadAssets).deleteAsset(id, ACTIVE_USER); }

    function loadHistory() { google.script.run.withSuccessHandler(d => { $('#history-table tbody').html(d.map(h => `<tr><td>${h.id}</td><td>${h.date}</td><td>${h.prod}</td><td>${h.cantidad}</td><td>$${formatMoney(h.total)}</td><td>${h.pay}</td><td>${h.user}</td></tr>`).join('')); }).getSalesHistory(); }

    function formatMoney(n) { return Math.floor(n||0).toLocaleString('es-CO'); }
    function closeModal(id) { $(`#${id}`).hide(); }
    function showNotif(msg, err) { const n = $('#notification'); n.text(msg).toggleClass('error', !!err).fadeIn(); setTimeout(()=>n.fadeOut(), 3000); }
  </script>
</body>
</html>